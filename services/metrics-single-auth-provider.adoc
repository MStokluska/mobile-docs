= Metrics single auth provider

== Introduction

The metrics service creates routes to access Grafana and Prometheus. To protect these routes there is an OAuth reverse proxy sidecar container in front 
of the Grafana and Prometheus containers to enable authentication. The authentication is based on Openshift permissions and is configured as part of the 
provisioning of the metrics service. You can refer to the documentation for the proxy container link:https://github.com/openshift/oauth-proxy[here] for 
more detailed information on how the proxy can be configured. 

The configuration for the metrics service is made up of two parts:

* Service account annotation
* Pod deploymentConfig

== OAuth proxy usage

When the metrics service has been provisioned there will be a route for Grafana and a route for Prometheus. 
When you access one of the routes you will see the OAuth proxy landing screen.
image:img/metrics-single-auth-provider/proxy.png[OAuth Proxy landing page]
Click *Log in with Openshift* and you will be brought to an Openshift login screen. Once you
have logged in with your Openshift credentials you will be asked to allow the service account
to access your account.
image:img/metrics-single-auth-provider/authorize.png[OAuth proxy service account authorize access]
Click *Allow selected permissions* to allow the service account to check you have the required permissions to access
the service. The OAuth proxy will then redirect you to the requested route after you have been authenticated.

== OAuth proxy configuration

=== Service Account Annotation

The OAuth proxy uses an Openshift service account annotation to define the redirect to the requested endpoint after the Openshift 
OAuth flow has authenticated the user.  For the metrics service we redirect to the external route for the Grafana or 
Prometheus service. This redirect is defined in the oauth-proxy-sa template 
link:https://github.com/aerogearcatalog/metrics-apb/blob/master/roles/provision-metrics-apb/templates/oauth-proxy-sa.yml.j2[here].

[source, yaml]
----
annotations:
   serviceaccounts.openshift.io/oauth-redirectreference.grafana: '{"kind":"OAuthRedirectReference","apiVersion":"v1","reference":{"kind":"Route","name":"grafana"}}'
   serviceaccounts.openshift.io/oauth-redirectreference.prometheus: '{"kind":"OAuthRedirectReference","apiVersion":"v1","reference":{"kind":"Route","name":"prometheus"}}'
----

More detailed information on OAuthRedirectReferences in annotations can be found link:https://docs.openshift.org/latest/architecture/additional_concepts/authentication.html#redirect-uris-for-service-accounts[here].

=== DeploymentConfig

The arguments passed into the deploymentConfig define some of the functionality of the OAuth proxy, most notably the Subject Access Review 
rule defined by _openshift-sar_. This means that for a user to be able to successfully authenticate against the OAuth proxy they must have 
sufficient permissions to update the deploymentConfig named, in this case, prometheus in the current Openshift namespace. 

[source,yaml]
----
--openshift-sar={"namespace":"{{ namespace }}","resource":"deploymentconfigs","name":"prometheus","verb":"update"}
----

WARNING: Giving a user update permissions on a resource will give them the ability to replace that resource object with a complete and modified configuration.
Access to the Prometheus and Grafana routes requires permissions to completely edit and replace the Prometheus and Grafana  deploymentConfigs.

The deploymentConfig also defines the service account used by the container and the server protected by the proxy, in this case it points to the prometheus
container and uses the oauth-proxy service account.

[source,yaml]
----
    --openshift-service-account={{ proxy_serviceaccount_name }}
    --upstream=http://localhost:{{ prometheus_port }}
----

This can be seen link:https://github.com/aerogearcatalog/metrics-apb/blob/master/roles/provision-metrics-apb/tasks/main.yml#L95[here] for the 
Prometheus pod of the metrics service.

== Additional Resources

* link:https://docs.openshift.com/container-platform/3.5/architecture/additional_concepts/authorization.html[Openshift Authorization]
* link:https://github.com/openshift/oauth-proxy[Openshift OAuth Proxy container]